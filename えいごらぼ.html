<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Quest Master</title>
    <title>English quest çˆ¶ã‹ã‚‰ã®æŒ‘æˆ¦çŠ¶</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .choice-btn:active {
            transform: scale(0.95);
        }

        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .score-dot {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            font-size: 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* å†™çœŸã®åˆ‡ã‚Šå–ã‚Šä½ç½®ã‚’èª¿æ•´ */
        .reward-img {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
            object-position: 100% 2%;
            border: 4px solid #4ade80;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        /* éœ‡ãˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¿®æ­£ç‰ˆ */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-8px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(8px);
            }
        }

        .animate-shake {
            /* 0.5ç§’ã‹ã‘ã¦ã€2å›ï¼ˆåˆè¨ˆ1ç§’ï¼‰ãƒ–ãƒ«ãƒ–ãƒ«ã•ã›ã¾ã™ */
            animation: shake 0.5s ease-in-out 0s 2;
        }

        /* èª­ã¿ä¸Šã’ä¸­ã®å˜èªã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .reading-word {
            background-color: #fef08a;
            /* è–„ã„é»„è‰² */
            color: #b45309;
            /* æ¿ƒã„èŒ¶è‰² */
            border-radius: 4px;
            transition: all 0.1s ease;
        }

        /* ç”»åƒä»˜ããƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³æ¼”å‡º */
header.relative {
    animation: headerSlideIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes headerSlideIn {
    from { opacity: 0; transform: scale(0.95) translateY(-20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col items-center p-4 font-sans text-slate-800">

    <div id="mode-screen" class="w-full max-w-lg fade-in">
       <header class="relative w-full mb-10 overflow-hidden rounded-[2.5rem] shadow-2xl h-64 bg-slate-200">
    <img src="img/cover.png" alt="Here We Go! Cover" class="absolute inset-0 w-full h-full object-cover opacity-70">
    
    <div class="absolute inset-0 bg-gradient-to-t from-indigo-900/90 via-indigo-900/40 to-transparent flex flex-col justify-end p-8 text-left">
        <div class="inline-block bg-orange-500 text-white text-[10px] font-black px-3 py-1 rounded-full mb-3 w-fit tracking-widest uppercase">
            2025å¹´åº¦ç‰ˆ Here We Go! ä¸­2 æº–æ‹ 
        </div>
        <h1 class="text-4xl font-black text-white tracking-tighter leading-tight mb-1">
            <span class="italic">Here We Go!</span> Quest
        </h1>
        <p class="text-indigo-100 text-lg font-bold">çˆ¶ã‹ã‚‰ã®æŒ‘æˆ¦çŠ¶</p>
    </div>
</header>
        <div class="grid grid-cols-1 gap-6">
            <button onclick="selectMode('textbook')"
                class="group bg-white p-8 rounded-[2.5rem] shadow-xl border-b-8 border-rose-200 hover:bg-rose-600 transition-all active:scale-95">
                <span class="block text-4xl mb-2">ğŸ“¢</span>
                <span class="block text-2xl font-black text-slate-700 group-hover:text-white">æ•™ç§‘æ›¸æœ¬æ–‡</span>
                <span class="block text-sm text-slate-400 group-hover:text-rose-100">éŸ³èª­ã¨ãƒã‚¤ãƒ³ãƒˆç¢ºèª</span>
            </button>
            <button onclick="selectMode('fill')"
                class="group bg-white p-8 rounded-[2.5rem] shadow-xl border-b-8 border-emerald-200 hover:bg-emerald-600 transition-all active:scale-95">
                <span class="block text-4xl mb-2">ğŸ“</span>
                <span class="block text-2xl font-black text-slate-700 group-hover:text-white">ç©´åŸ‹ã‚å•é¡Œ</span>
                <span class="block text-sm text-slate-400 group-hover:text-emerald-100">æ–‡æ³•ã®æ€¥æ‰€ã‚’ã­ã‚‰ãˆ</span>
            </button>
            <button onclick="selectMode('reorder')"
                class="group bg-white p-8 rounded-[2.5rem] shadow-xl border-b-8 border-indigo-200 hover:bg-indigo-600 transition-all active:scale-95">
                <span class="block text-4xl mb-2">ğŸ§©</span>
                <span class="block text-2xl font-black text-slate-700 group-hover:text-white">ä¸¦ã¹æ›¿ãˆå•é¡Œ</span>
                <span class="block text-sm text-slate-400 group-hover:text-indigo-100">èªé †ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†</span>
            </button>
            <button onclick="selectMode('story')"
                class="group bg-white p-8 rounded-[2.5rem] shadow-xl border-b-8 border-orange-200 hover:bg-orange-600 transition-all active:scale-95">
                <span class="block text-4xl mb-2">ğŸ“–</span>
                <span class="block text-2xl font-black text-slate-700 group-hover:text-white">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼èª­è§£</span>
                <span class="block text-sm text-slate-400 group-hover:text-orange-100">ãŠè©±ã‚’èª­ã‚“ã§å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼</span>
            </button>

        </div>
    </div>

    <div id="unit-screen" class="w-full max-w-2xl hidden fade-in">
        <header class="flex justify-between items-center my-10">
            <button onclick="location.reload()" class="text-indigo-500 font-bold">â† ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´</button>
            <h2 id="unit-header-title" class="text-xl font-black text-slate-700 uppercase">Select Unit</h2>
            <div class="w-10"></div>
        </header>
        <div id="unit-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20"></div>
    </div>
    <div id="story-index-screen" class="hidden w-full max-w-2xl bg-white p-8 rounded-[3rem] shadow-2xl fade-in">
        <header class="text-center mb-10">
            <h2 class="text-3xl font-black text-orange-500 italic">Story Index</h2>
            <p class="text-slate-400 font-bold text-xs uppercase tracking-widest mt-2">æ•™ç§‘æ›¸ã®å†…å®¹ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†</p>
        </header>

        <div id="story-index-list" class="grid grid-cols-1 gap-4"></div>
    </div>
    <div id="story-screen"
        class="hidden w-full max-w-2xl bg-white p-8 rounded-[3rem] shadow-2xl fade-in overflow-y-auto max-h-[90vh]">
        <div id="story-display-area" class="prose prose-slate"></div>
    </div>
    <div id="quiz-screen" class="w-full max-w-lg hidden fade-in">
        <header class="flex justify-between items-center my-4 px-2">
            <button onclick="showUnitSelect()" class="text-indigo-500 font-bold">Ã— æˆ»ã‚‹</button>
            <div id="progress-text" class="text-sm font-black text-slate-400">1 / 10</div>
            <div class="w-24 bg-slate-200 rounded-full h-2">
                <div id="progress-bar" class="bg-indigo-500 h-2 rounded-full transition-all duration-500"></div>
            </div>
        </header>

        <main class="bg-white rounded-[2.5rem] shadow-2xl p-6 border-b-8 border-indigo-100">
            <p id="japanese-text" class="text-xl font-bold text-center mb-6 text-slate-700"></p>

            <div id="reorder-display"
                class="hidden min-h-[100px] border-2 border-dashed border-slate-100 rounded-3xl flex flex-wrap gap-2 p-4 mb-6 bg-slate-50/50 text-indigo-700 font-bold items-center justify-center text-lg">
            </div>

            <div id="fill-display" class="hidden text-2xl font-black text-center mb-10 text-slate-800">
                <span id="text-before"></span>
                <span id="blank-space" class="mx-2 px-6 py-1 border-b-4 border-indigo-500 text-indigo-600">___</span>
                <span id="text-after"></span>
            </div>

            <div id="feedback-detail"
                class="hidden mb-6 p-4 rounded-2xl text-center bg-slate-50 border border-slate-100">
                <div id="face-image-container" class="hidden mb-4 flex justify-center">
                    <img id="feedback-img" src="" class="reward-img animate-bounce">
                </div>
                <p id="judgment-text" class="font-black text-3xl mb-2"></p>
                <p id="correct-answer-text" class="text-indigo-600 font-bold text-base"></p>
            </div>

            <div id="choices-area" class="flex flex-wrap gap-2 justify-center mb-8"></div>

            <div id="quiz-controls" class="flex gap-2">
                <button id="main-action-btn"
                    class="flex-[3] bg-indigo-600 text-white py-5 rounded-2xl font-bold shadow-lg">æ±ºå®š</button>
                <button id="undo-btn" onclick="undoWord()"
                    class="flex-1 bg-amber-50 text-amber-600 py-5 rounded-2xl font-bold">æˆ»ã™</button>
            </div>
            <button id="next-btn" onclick="nextQuestion()"
                class="hidden w-full bg-slate-800 text-white py-5 rounded-2xl font-bold shadow-lg">æ¬¡ã¸é€²ã‚€ â”</button>
        </main>
    </div>

    <div id="result-screen" class="w-full max-w-lg hidden text-center fade-in">
        <div class="bg-white rounded-[3rem] shadow-2xl p-10 mt-10 border-b-8 border-indigo-50">
            <div id="result-icon" class="text-8xl mb-6">ğŸ†</div>
            <p id="result-score" class="text-7xl font-black text-indigo-600 mb-6">0 / 10</p>
            <button onclick="showUnitSelect()"
                class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-bold shadow-lg">å˜å…ƒã‚’é¸ã³ç›´ã™</button>
        </div>
    </div>

    <script>
        let gameMode = ""; // 'reorder' or 'fill'
        let allData = {}; let currentQuestions = []; let currentIndex = 0; let score = 0;
        let userSelection = []; let selectionOrder = [];

        const pronunciationMap = { "a": "uh", "I": "eye" };

        // èª­ã¿ä¸Šã’é€Ÿåº¦ã®åˆæœŸå€¤ï¼ˆ0.8å€é€Ÿï¼‰
        let currentSpeechRate = 0.8;

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã—ãŸæ™‚ã«å‘¼ã°ã‚Œã‚‹é–¢æ•°
        function updateRate(val) {
            currentSpeechRate = parseFloat(val);
            document.getElementById('rate-display').innerText = val + 'x';
        }

        function speak(text, shouldHighlight = false) {
            // èª­ã¿ä¸Šã’ä¸­ã®éŸ³å£°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            window.speechSynthesis.cancel();

            // 1. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼šåå‰ï¼ˆTina: ãªã©ï¼‰ã‚’æ¶ˆã—ã€æ”¹è¡Œã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›
            let cleanText = text.replace(/^[A-Za-z\s\/\.]*:\s*/gm, "")
                      .replace(/&quot;/g, '"')
                      .replace(/\n/g, " ");


            
            // 2. â˜…ç™ºéŸ³è£œæ­£ï¼šI ã‚’ eyeã€a ã‚’ uh ã«ç½®ãæ›ãˆã‚‹ï¼ˆå˜èªã®å¢ƒç•Œ \b ã‚’å®ˆã‚‹ï¼‰
            let phoneticText = cleanText;
            if (typeof pronunciationMap !== 'undefined') {
                Object.keys(pronunciationMap).forEach(key => {
                    // \b ã‚’ä½¿ã†ã“ã¨ã§ "interested" ã®ä¸­ã® "i" ãŒå¤‰ã‚ã‚‹ã®ã‚’é˜²ãã¾ã™
                    const regex = new RegExp(`\\b${key}\\b`, 'g');
                    phoneticText = phoneticText.replace(regex, pronunciationMap[key]);
                });
            }

            // èª­ã¿ä¸Šã’ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆè£œæ­£å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨ï¼‰
            const utter = new SpeechSynthesisUtterance(phoneticText);
            utter.lang = 'en-US';

            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§è¨­å®šã—ãŸé€Ÿåº¦ã‚’é©ç”¨
            utter.rate = currentSpeechRate;

            // 3. ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†ï¼ˆæ•™ç§‘æ›¸ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
            if (shouldHighlight) {
                utter.onboundary = (event) => {
                    if (event.name === 'word') {
                        // ç¾åœ¨èª­ã‚“ã§ã„ã‚‹ä½ç½®ã¾ã§ã®å˜èªæ•°ã‚’æ•°ãˆã‚‹
                        const textUpToHere = phoneticText.substring(0, event.charIndex);
                        const wordsArray = textUpToHere.match(/\S+/g) || [];
                        const currentWordIndex = wordsArray.length;

                        // æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆå»
                        document.querySelectorAll('.reading-word').forEach(el => el.classList.remove('reading-word'));

                        // è©²å½“ã™ã‚‹å˜èªã‚¹ãƒ‘ãƒ³ã‚’å…‰ã‚‰ã›ã‚‹
                        const currentWordSpan = document.getElementById(`read-word-${currentWordIndex}`);
                        if (currentWordSpan) {
                            currentWordSpan.classList.add('reading-word');
                            currentWordSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                };

                utter.onend = () => {
                    document.querySelectorAll('.reading-word').forEach(el => el.classList.remove('reading-word'));
                };
            } else {
                // ãƒã‚¤ãƒ©ã‚¤ãƒˆä¸è¦ãªãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¯ã‚¤ã‚ºãªã©ï¼‰ã§ã¯ã€è‰²ã‚’ç¢ºå®Ÿã«æ¶ˆã™
                document.querySelectorAll('.reading-word').forEach(el => el.classList.remove('reading-word'));
            }

            window.speechSynthesis.speak(utter);
        }


        async function selectMode(mode) {
            gameMode = mode;
            // â˜…ã“ã“ã‚’ä¿®æ­£ï¼š 'textbook' ãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã‚‚ 'story_data.json' ã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ã—ã¾ã™
            const fileName = (mode === 'story' || mode === 'textbook') ? 'story_data.json' :
                (mode === 'fill') ? 'questions_fill.json' : 'questions.json';

            try {
                const response = await fetch(fileName);
                if (!response.ok) throw new Error("File not found");
                allData = await response.json();

                document.getElementById('mode-screen').classList.add('hidden');

                if (mode === 'story') {
                    renderStoryIndex();
                } else if (mode === 'textbook') {
                    renderTextbookIndex();
                } else {
                    document.getElementById('unit-screen').classList.remove('hidden');
                    renderUnitList();
                }
            } catch (error) {
                alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚" + fileName + "ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }

        // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç›®æ¬¡ã‚’ä½œæˆã™ã‚‹é–¢æ•°ï¼ˆæœ¬æ–‡ç”»é¢ã‚’éš ã™å‘½ä»¤ã‚’è¿½åŠ ï¼‰
        function renderStoryIndex() {
            // --- â˜…ã“ã“ãŒé‡è¦ï¼šæœ¬æ–‡ãƒ»ã‚¯ã‚¤ã‚ºç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦éš ã™ ---
            document.getElementById('story-screen').classList.add('hidden');
            // ---------------------------------------------------------------

            const list = document.getElementById('story-index-list');
            const screen = document.getElementById('story-index-screen');
            list.innerHTML = "";
            screen.classList.remove('hidden'); // ç›®æ¬¡ç”»é¢ã‚’è¡¨ç¤º

            Object.keys(allData).forEach(id => {
                const card = document.createElement('button');
                card.className = "flex items-center justify-between bg-orange-50 hover:bg-orange-500 hover:text-white p-6 rounded-3xl border-2 border-orange-100 transition-all group mb-4 w-full";
                card.onclick = () => renderPartSelect(id);

                card.innerHTML = `
            <div class="text-left">
                <span class="text-xs font-bold text-orange-400 group-hover:text-orange-100 uppercase">${id}</span>
                <h3 class="text-xl font-black">${allData[id].title}</h3>
            </div>
            <span class="text-2xl">ğŸ“–</span>
        `;
                list.appendChild(card);
            });

            // ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³
            const backBtn = document.createElement('button');
            backBtn.className = "mt-10 w-full py-4 bg-slate-100 hover:bg-slate-200 text-slate-500 rounded-2xl font-black transition-all";
            backBtn.innerText = "ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹";
            backBtn.onclick = () => location.reload();
            list.appendChild(backBtn);
        }


        function renderTextbookIndex() {
            document.getElementById('story-screen').classList.add('hidden');
            const list = document.getElementById('story-index-list');
            const screen = document.getElementById('story-index-screen');
            list.innerHTML = "";
            screen.classList.remove('hidden');

            Object.keys(allData).forEach(id => {
                const card = document.createElement('button');
                card.className = "flex items-center justify-between bg-rose-50 hover:bg-rose-600 hover:text-white p-6 rounded-3xl border-2 border-rose-100 transition-all group mb-4 w-full";
                card.onclick = () => renderPartSelect(id);
                card.innerHTML = `
            <div class="text-left">
                <span class="text-xs font-bold text-rose-400 group-hover:text-rose-100 uppercase">${id}</span>
                <h3 class="text-xl font-black">${allData[id].title}</h3>
            </div>
            <span class="text-2xl">ğŸ“¢</span>
        `;
                list.appendChild(card);
            });

            const backBtn = document.createElement('button');
            backBtn.className = "mt-10 w-full py-4 bg-slate-100 text-slate-500 rounded-2xl font-black transition-all";
            backBtn.innerText = "ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹";
            backBtn.onclick = () => location.reload();
            list.appendChild(backBtn);
        }


        // ãƒ‘ãƒ¼ãƒˆé¸æŠç”»é¢ã‚’è¡¨ç¤ºï¼ˆè¡Œãå…ˆã‚’ãƒ¢ãƒ¼ãƒ‰ã§æŒ¯ã‚Šåˆ†ã‘ã‚‹ï¼‰
        function renderPartSelect(unitId) {
            document.getElementById('story-screen').classList.add('hidden');
            document.getElementById('story-index-screen').classList.remove('hidden');

            const list = document.getElementById('story-index-list');
            list.innerHTML = `
        <h3 class="text-2xl font-black mb-6 text-center text-orange-600">${allData[unitId].title}</h3>
        <p class="text-center text-slate-400 text-xs mb-6 uppercase tracking-widest">Select a Part</p>
    `;

            allData[unitId].parts.forEach((part, index) => {
                const btn = document.createElement('button');
                btn.className = "w-full mb-3 bg-white p-6 rounded-2xl border-2 border-orange-100 hover:border-orange-500 text-left font-bold transition-all flex justify-between items-center group shadow-sm";
                btn.innerHTML = `
            <span class="group-hover:text-orange-600 transition-colors">${part.partTitle}</span>
            <span class="text-orange-300 group-hover:translate-x-1 transition-transform">â”</span>
        `;
                btn.onclick = () => {
                    document.getElementById('story-index-screen').classList.add('hidden');
                    document.getElementById('story-screen').classList.remove('hidden');

                    // â˜…é‡è¦ï¼šã“ã“ã‚’ä¿®æ­£ï¼ ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°ã‚’å¤‰ãˆã¾ã™
                    if (gameMode === 'textbook') {
                        displayTextbook(unitId, index); // ã€Œæ•™ç§‘æ›¸æœ¬æ–‡ã€ãªã‚‰ä¼šè©±æ–‡ã‚’è¡¨ç¤º
                    } else {
                        displayPart(unitId, index);     // ã€Œèª­è§£ã‚¯ã‚¤ã‚ºã€ãªã‚‰è¦ç´„ã‚’è¡¨ç¤º
                    }
                };
                list.appendChild(btn);
            });

            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢
            const navDiv = document.createElement('div');
            navDiv.className = "mt-10 flex flex-col gap-3 pb-10";
            navDiv.innerHTML = `
        <button onclick="renderStoryIndex()" class="w-full py-4 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-2xl font-black transition-all flex items-center justify-center gap-2">
            <span>â†</span> å˜å…ƒã‚’é¸ã³ç›´ã™
        </button>
        <button onclick="location.reload()" class="w-full py-4 bg-slate-100 hover:bg-slate-200 text-slate-500 rounded-2xl font-black transition-all flex items-center justify-center gap-2">
            <span>ğŸ </span> ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
        </button>
    `;
            list.appendChild(navDiv);
        }


        function displayPart(unitId, partIndex) {
            const part = allData[unitId].parts[partIndex];
            const storyArea = document.getElementById('story-display-area');

            // 1. æœ¬æ–‡ã‚¨ãƒªã‚¢
            storyArea.innerHTML = `
        <h2 class="text-orange-500 font-black mb-4 text-2xl border-l-8 border-orange-500 pl-4">${part.partTitle}</h2>
        <div class="bg-slate-50 p-6 rounded-3xl mb-8 border border-slate-100 shadow-inner">
            <p class="text-xl leading-relaxed mb-6 font-medium text-slate-700">${part.en}</p>
            <p class="text-base text-slate-500 border-t pt-4 leading-relaxed">${part.jp}</p>
        </div>
        <hr class="my-8 border-orange-100">
        <h4 class="font-black text-center mb-6 text-orange-400 tracking-widest uppercase">Reading Check</h4>
    `;

            // 2. ã‚¯ã‚¤ã‚ºã‚¨ãƒªã‚¢
            part.ox_quiz.forEach((q, idx) => {
                storyArea.innerHTML += `
            <div class="mb-6 p-6 bg-white border-2 border-slate-100 rounded-[2rem] shadow-sm">
                <p class="font-bold mb-6 text-lg text-slate-700 italic">" ${q.q_en} "</p>
                <div class="flex gap-4">
                    <button onclick="checkPartOX('${unitId}', ${partIndex}, ${idx}, 'ã€‡')" class="flex-1 py-4 bg-blue-500 hover:bg-blue-600 text-white rounded-2xl font-black shadow-lg transition-all">TRUE (ã€‡)</button>
                    <button onclick="checkPartOX('${unitId}', ${partIndex}, ${idx}, 'Ã—')" class="flex-1 py-4 bg-red-500 hover:bg-red-600 text-white rounded-2xl font-black shadow-lg transition-all">FALSE (Ã—)</button>
                </div>
                <div id="part-ox-feedback-${idx}" class="mt-6 hidden p-4 rounded-2xl border leading-relaxed">
                    <p id="part-ox-qjp-${idx}" class="font-bold text-slate-600 mb-2"></p>
                    <p id="part-ox-exp-${idx}" class="text-sm text-slate-500"></p>
                </div>
            </div>
        `;
            });

            // 3. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç¾¤ï¼ˆã“ã“ã§ã¾ã¨ã‚ã¦è¿½åŠ ï¼‰
            const navDiv = document.createElement('div');
            navDiv.className = "mt-12 flex flex-col gap-3 pb-10";
            navDiv.innerHTML = `
        <button onclick="renderPartSelect('${unitId}')" class="w-full py-4 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-2xl font-black transition-all flex items-center justify-center gap-2">
            <span>â†</span> ãƒ‘ãƒ¼ãƒˆä¸€è¦§ã«æˆ»ã‚‹
        </button>
        <button onclick="renderStoryIndex()" class="w-full py-4 bg-orange-50 hover:bg-orange-100 text-orange-600 rounded-2xl font-black transition-all flex items-center justify-center gap-2">
            å˜å…ƒã‚’é¸ã³ç›´ã™
        </button>
        <button onclick="location.reload()" class="w-full py-4 bg-slate-100 hover:bg-slate-200 text-slate-400 rounded-2xl font-black transition-all flex items-center justify-center gap-2">
            ğŸ  ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        </button>
    `;
            storyArea.appendChild(navDiv);
        }

        // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
        function checkPartOX(unitId, partIndex, qIndex, userAnswer) {
            const quiz = allData[unitId].parts[partIndex].ox_quiz[qIndex];
            const feedbackEl = document.getElementById(`part-ox-feedback-${qIndex}`);
            const qjpEl = document.getElementById(`part-ox-qjp-${qIndex}`);
            const expEl = document.getElementById(`part-ox-exp-${qIndex}`);

            feedbackEl.classList.remove('hidden');

            if (userAnswer === quiz.a) {
                // æ­£è§£ã®ã¨ã
                feedbackEl.className = "mt-6 p-4 rounded-2xl border border-green-200 bg-green-50";
                qjpEl.innerHTML = `<span class="text-green-600 font-black">âœ¨ Correct!</span>`;
                expEl.innerText = quiz.exp;
            } else {
                // é–“é•ãˆãŸã¨ãï¼šæ—¥æœ¬èªã®è³ªå•æ–‡ã¨è§£èª¬ã‚’è¡¨ç¤º
                feedbackEl.className = "mt-6 p-4 rounded-2xl border border-red-200 bg-red-50";
                qjpEl.innerHTML = `<span class="text-red-600 font-black">âŒ Try Again!</span><br><span class="text-sm text-slate-600">å•ã„ï¼š${quiz.q_jp}</span>`;
                expEl.innerText = quiz.exp;
            }
        }

        function displayTextbook(unitId, partIndex) {
            const part = allData[unitId].parts[partIndex];
            const storyArea = document.getElementById('story-display-area');

            // æ•™ç§‘æ›¸æœ¬æ–‡ç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ãƒ«ãƒ†ã‚­ã‚¹ãƒˆï¼‰
            const textEn = part.full_en || part.en;
            const textJp = part.full_jp || part.jp;

            // --- æ•™ç§‘æ›¸æœ¬æ–‡ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨åˆ†å‰²ãƒ­ã‚¸ãƒƒã‚¯ ---
            let wordGlobalIndex = 0;
            const lines = textEn.split('\n');
            const highlightedEn = lines.map(line => {
                // åå‰ï¼ˆTina: ãªã©ï¼‰ã‚’æŠ½å‡º
                const namePartMatch = line.match(/^([A-Za-z\s\/\.]*:\s*)/);
                let namePart = "";
                let dialoguePart = line;

                if (namePartMatch) {
                    namePart = `<span class="text-slate-400 font-bold">${namePartMatch[1]}</span>`;
                    dialoguePart = line.substring(namePartMatch[1].length);
                }

                // ã‚»ãƒªãƒ•éƒ¨åˆ†ã‚’å˜èªã”ã¨ã«åˆ†å‰²ã—ã¦IDã‚’ä»˜ä¸
                const words = dialoguePart.trim().split(/\s+/);
                const spans = words.map(word => {
                    if (word === "") return "";
                    const span = `<span id="read-word-${wordGlobalIndex}" class="transition-colors">${word}</span>`;
                    wordGlobalIndex++;
                    return span;
                }).join(' ');

                return namePart + spans;
            }).join('<br>');

            // --- HTMLç”Ÿæˆï¼ˆã‚ã‚‰ã™ã˜ã¨ã‚¯ã‚¤ã‚ºã‚’é™¤å»ï¼‰ ---
            storyArea.innerHTML = `
        <div class="mb-6 flex flex-col gap-4">
            <div class="flex justify-between items-center">
                <h2 class="text-rose-500 font-black text-2xl border-l-8 border-rose-500 pl-4">${part.partTitle}</h2>
  
                    <button onclick="speak(\`${textEn.replace(/`/g, "\\`").replace(/\$/g, "\\$").replace(/"/g, "&quot;")}\`, true)" 
                       class="bg-rose-500 text-white px-6 py-2 rounded-full font-bold shadow-lg active:scale-95">
                       ğŸ“¢ æœ¬æ–‡ã‚’èª­ã¿ä¸Šã’ã‚‹
                     </button>
            </div>
            
            <div class="bg-white p-4 rounded-2xl border border-slate-200 flex items-center gap-4 shadow-sm">
                <span class="text-xs font-bold text-slate-400 uppercase">Speed</span>
                <input type="range" min="0.5" max="1.5" step="0.1" value="${currentSpeechRate}" 
                       oninput="updateRate(this.value)" 
                       class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-rose-500">
                <span id="rate-display" class="text-sm font-black text-rose-500 w-10">${currentSpeechRate}x</span>
            </div>
        </div>
        
        <div class="bg-slate-50 p-6 rounded-3xl mb-8 border border-slate-100 shadow-inner">
            <p id="en-text-container" class="text-xl leading-relaxed mb-6 font-medium text-slate-700">${highlightedEn}</p>
            <p class="text-base text-slate-500 border-t pt-4 whitespace-pre-wrap">${textJp}</p>
        </div>

        <div class="mb-6 p-5 bg-rose-50 rounded-2xl border-2 border-rose-100">
            <h4 class="font-black text-rose-600 mb-2 text-sm uppercase">ğŸ’¡ Check Point</h4>
            <p class="text-slate-700 text-sm leading-relaxed">${part.grammar || 'æº–å‚™ä¸­'}</p>
        </div>

        <div class="mb-10 p-5 bg-white border-2 border-slate-100 rounded-2xl shadow-sm">
            <h4 class="font-black text-slate-400 mb-3 text-sm uppercase tracking-widest">Keywords (Tap to Listen)</h4>
            <div class="flex flex-wrap gap-2">
                ${part.vocab ? part.vocab.map(v => {
                const englishWord = v.split('(')[0].trim();
                return `
                        <span onclick="speak('${englishWord.replace(/'/g, "\\'")}', false)" 
                              class="cursor-pointer bg-slate-100 px-3 py-1 rounded-lg text-sm font-bold text-slate-600 hover:bg-rose-100 hover:text-rose-600 transition-all active:scale-95 shadow-sm border border-transparent">
                            ${v}
                        </span>`;
            }).join('') : 'å˜èªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'}
            </div>
        </div>

        <div class="flex flex-col gap-3 pb-10">
            <button onclick="renderPartSelect('${unitId}')" class="w-full py-4 bg-rose-100 text-rose-700 rounded-2xl font-black shadow-sm active:scale-95 transition-all">
                â† ãƒ‘ãƒ¼ãƒˆä¸€è¦§ã«æˆ»ã‚‹
            </button>
            <button onclick="location.reload()" class="w-full py-4 bg-slate-100 text-slate-400 rounded-2xl font-black shadow-sm active:scale-95 transition-all">
                ğŸ  ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            </button>
        </div>
    `;
        }
        function renderUnitList() {
            const list = document.getElementById('unit-list'); list.innerHTML = "";
            const historyKey = `eng_quest_history_${gameMode}`;
            const history = JSON.parse(localStorage.getItem(historyKey) || '{}');

            Object.keys(allData).forEach(id => {
                const unitHistory = history[id] || [];
                const highscore = unitHistory.length > 0 ? Math.max(...unitHistory) : 0;
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-[2rem] border border-slate-100 shadow-sm cursor-pointer transition active:scale-95";
                card.onclick = () => startQuiz(id);

                let dots = "";
                for (let i = 0; i < 10; i++) {
                    const s = unitHistory[i];
                    const color = s === 10 ? 'bg-green-500' : s >= 8 ? 'bg-indigo-500' : (s !== undefined ? 'bg-slate-300' : 'bg-slate-50 border');
                    dots += `<div class="score-dot ${color} text-white">${s !== undefined ? s : ''}</div>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-black text-slate-700 text-lg">${allData[id].title}</h3>
                        <span class="text-xl font-black text-indigo-600">${highscore}</span>
                    </div>
                    <div class="flex gap-1 justify-between">${dots}</div>
                `;
                list.appendChild(card);
            });
        }

        function startQuiz(unitId) {
            currentQuestions = [...allData[unitId].questions].sort(() => 0.5 - Math.random()).slice(0, 10);
            currentIndex = 0; score = 0;
            document.getElementById('unit-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            initQuestion();
        }

        function initQuestion() {
            const q = currentQuestions[currentIndex];
            userSelection = []; selectionOrder = [];
            document.getElementById('feedback-detail').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('quiz-controls').classList.remove('hidden');
            document.getElementById('choices-area').classList.remove('hidden');
            document.getElementById('japanese-text').innerText = q.jp;
            document.getElementById('progress-text').innerText = `${currentIndex + 1} / 10`;
            document.getElementById('progress-bar').style.width = `${((currentIndex + 1) / 10) * 100}%`;

            const area = document.getElementById('choices-area'); area.innerHTML = "";

            if (gameMode === 'reorder') {
                document.getElementById('reorder-display').classList.remove('hidden');
                document.getElementById('fill-display').classList.add('hidden');
                document.getElementById('undo-btn').classList.remove('hidden');
                document.getElementById('reorder-display').innerText = "";
                document.getElementById('main-action-btn').onclick = () => checkAnswer();

                [...q.en].sort(() => Math.random() - 0.5).forEach((word, idx) => {
                    const btn = document.createElement('button');
                    btn.innerText = word; btn.id = `btn-${idx}`;
                    btn.className = "bg-white border-2 border-slate-100 px-4 py-2 rounded-2xl font-bold shadow-sm active:bg-indigo-50";
                    btn.onclick = () => {
                        if (btn.classList.contains('invisible')) return;
                        speak(word); userSelection.push(word); selectionOrder.push(btn.id);
                        btn.classList.add('invisible');
                        document.getElementById('reorder-display').innerText = userSelection.join(' ');
                    };
                    area.appendChild(btn);
                });
            } else {
                document.getElementById('reorder-display').classList.add('hidden');
                document.getElementById('fill-display').classList.remove('hidden');
                document.getElementById('undo-btn').classList.add('hidden');
                document.getElementById('text-before').innerText = q.before;
                document.getElementById('text-after').innerText = q.after;
                document.getElementById('blank-space').innerText = "___";
                document.getElementById('quiz-controls').classList.add('hidden');

                q.choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.innerText = choice;
                    btn.className = "w-full bg-white border-2 border-slate-100 py-4 rounded-2xl font-bold text-xl active:bg-emerald-50";
                    btn.onclick = () => checkAnswer(choice);
                    area.appendChild(btn);
                });
            }
        }

        function undoWord() {
            if (selectionOrder.length === 0) return;
            const lastId = selectionOrder.pop(); userSelection.pop();
            document.getElementById(lastId).classList.remove('invisible');
            document.getElementById('reorder-display').innerText = userSelection.join(' ');
        }

        function checkAnswer(fillChoice) {
            const q = currentQuestions[currentIndex];
            let isCorrect = false;
            let fullText = "";

            // ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®æ­£èª¤åˆ¤å®š
            if (gameMode === 'reorder') {
                isCorrect = userSelection.join(' ') === q.en.join(' ');
                fullText = q.en.join(' ');
            } else {
                isCorrect = fillChoice === q.answer;
                fullText = `${q.before} ${q.answer} ${q.after}`.trim();
                document.getElementById('blank-space').innerText = q.answer;
            }

            // ç”»é¢è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('choices-area').classList.add('hidden');
            document.getElementById('quiz-controls').classList.add('hidden');
            document.getElementById('feedback-detail').classList.remove('hidden');
            document.getElementById('next-btn').classList.remove('hidden');

            const jud = document.getElementById('judgment-text');
            const faceContainer = document.getElementById('face-image-container');
            const feedbackImg = document.getElementById('feedback-img');

            // â˜…é‡è¦ï¼šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸€åº¦ãƒªã‚»ãƒƒãƒˆã™ã‚‹
            feedbackImg.classList.remove('animate-bounce', 'animate-shake');

            if (isCorrect) {
                // --- æ­£è§£ã—ãŸæ™‚ã®å‡¦ç† ---
                jud.innerText = "æ­£è§£ï¼ âœ¨";
                jud.className = "text-4xl font-black text-green-500";
                feedbackImg.src = "img/face.png"; // æ­£è§£ç”»åƒ

                // å¼¾ã‚€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                setTimeout(() => {
                    feedbackImg.classList.add('animate-bounce');
                }, 10);

                faceContainer.classList.remove('hidden');
                speak(fullText);
                score++;
            } else {
                // --- é–“é•ãˆãŸæ™‚ã®å‡¦ç† ---
                jud.innerText = "æ®‹å¿µ âŒ";
                jud.className = "text-4xl font-black text-red-500";
                feedbackImg.src = "img/wrong.png";

                // ã‚¯ãƒ©ã‚¹ã‚’ä¸€åº¦å®Œå…¨ã«æ¶ˆã—ã¦ã‹ã‚‰ã€ä¸€ç¬é…ã‚Œã¦è¿½åŠ ã™ã‚‹
                feedbackImg.classList.remove('animate-shake');

                // ãƒ–ãƒ©ã‚¦ã‚¶ã«ã€Œã‚¯ãƒ©ã‚¹ãŒæ¶ˆãˆãŸã“ã¨ã€ã‚’èªè­˜ã•ã›ã‚‹ãŸã‚ã®é­”æ³•ã®1è¡Œ
                void feedbackImg.offsetWidth;

                // å†ã³éœ‡ã‚ã›ã‚‹
                feedbackImg.classList.add('animate-shake');

                faceContainer.classList.remove('hidden');
            }
            document.getElementById('correct-answer-text').innerText = fullText;
        }
        function nextQuestion() {
            currentIndex++;
            if (currentIndex >= 10) {
                document.getElementById('quiz-screen').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
                document.getElementById('result-score').innerText = `${score} / 10`;
                const key = `eng_quest_history_${gameMode}`;
                const history = JSON.parse(localStorage.getItem(key) || '{}');
                const unitId = Object.keys(allData).find(k => allData[k].questions.includes(currentQuestions[0]));
                if (!history[unitId]) history[unitId] = [];
                history[unitId].push(score); if (history[unitId].length > 10) history[unitId].shift();
                localStorage.setItem(key, JSON.stringify(history));
            } else {
                initQuestion();
            }
        }
        // çµæœç”»é¢ã‹ã‚‰å˜å…ƒé¸æŠã«æˆ»ã‚‹ãŸã‚ã®é–¢æ•°
        function showUnitSelect() {
            // çµæœç”»é¢ã‚’éš ã™
            document.getElementById('result-screen').classList.add('hidden');
            // å˜å…ƒé¸æŠç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
            document.getElementById('unit-screen').classList.remove('hidden');
            // å˜å…ƒãƒªã‚¹ãƒˆã‚’å†æç”»ï¼ˆã‚¹ã‚³ã‚¢ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ï¼‰
            renderUnitList();
        }


    </script>
</body>

</html>